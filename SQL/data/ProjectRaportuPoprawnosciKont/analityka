DECLARE v_data3 DATE;
DECLARE v_curr DATE;
DECLARE currData STRING;

SET v_data3=date_sub(current_date(),interval 3 year);
SET v_curr=current_date();
SET currData=cast(v_curr as STRING);
-- SET v_curr=cast(v_curr as String);
CREATE TEMP FUNCTION czySenior(currentDate STRING,dateOfBirt STRING)
returns BOOL
LANGUAGE js
 as
r'''
    const v_cur=currentDate.split('-')
    const last=dateOfBirt.split('-')
    if((v_cur[0]-last[0])>60){
        return true;
      }
    else if(((v_cur[0]-last[0])==60)&& (v_cur[1]>=last[1]) && (v_cur[2]>=last[2])){
        return true;
        }
        else {
    return false;
}
''';
-- ilość kont z przedrostkiem email usun1_ usun2_ usun_ usun3_ jako główny
/*
select 
distinct
person_id,
mail
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where lower(mail) like 'usun%' or lower(mail) like '%usun'
and MainMail=true
*/
-- ilość kont bez aktywności > 3 lata


select 
distinct 
person_id
,last_interaction
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where last_interaction<v_data3


-- ilość założonych kont klienta
/*select 
person_id,
createDa,
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`*/

-- ilość kont z potwierdzonym DA

/*
select 
distinct
person_id,
createDa,
ConfirmationDA,
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where createDa is not null and ConfirmationDA is not null
*/
-- ilość kont z niepotwierdzonych DA

/*
select 
distinct 
person_id,
createDa,
ConfirmationDA,
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where createDa is not null and ConfirmationDA is  null
*/

-- ilość uniklanych adresów email które występują na >1 koncie jako main
/*with mail as (select 
distinct 
lower(mail) as mail,
count(distinct person_id)
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where mail is not null
and MainMail=true
group by 1 
having count(distinct person_id)>1)

select 
distinct
person_id,
ma.mail,
MainMail
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main` main
join mail ma on lower(main.mail)=ma.mail
order by 2
*/
-- ilość kont z multi-emailami
/*
with konto as (
  select 
distinct 
person_id,
count(distinct mail)
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where mail is not null
group by 1 
having count(distinct mail)>1)

select 
distinct
main.person_id,
mail,
MainMail
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main` main
join konto k on main.person_id=k.person_id
*/
-- join mail ma on lower(main.mail)=ma.mail
-- order by 2
-- ilość kont z multi-telefonami
/*with konto as (  
  select 
distinct 
person_id,
count(distinct telefon)
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where mail is not null
group by 1 
having count(distinct telefon)>1)

select 
distinct
main.person_id,
telefon
MainTelefon
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main` main
join konto k on main.person_id=k.person_id*/
-- ilość kont z >1 aktywnymi kartami skarbonka
/*
with skarbonka as (  
  select 
distinct 
person_id,
count(distinct karta)
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main`
where karta is not null 
and status ='LOS_01'
group by 1 
having count(distinct karta)>1
)
select 
distinct
main.person_id,
karta,
status
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main` main
join skarbonka k on main.person_id=k.person_id
*/
-- ilość klientów których nie ma w SF a jest w Ocado
/*
select
distinct
 person_id 

from 
`pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main` ma
where sprawa='NOT_OK'
*/
-- brak optin dla kanału email main na koncie ale zgoda na newslettery

-- status KDR bez wpisanego numeru karty KDR
/*
select 
person_id,
KDR,
nrKartKDR
from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main` ma
where KDR='AKTYWNY'
and nrKartKDR is null 
*/
-- status senior nieodpowiadający wiekowi w profilu
-- with czySenior as (select 
-- person_id,
-- SENIOR,
-- birth_date,
-- czySenior(currData,cast(birth_date as string)) czyJestSenior
-- from `pol-it-digiteam-2022062900.WalidacjaAnomaliSFC.Main` ma
-- where SENIOR='AKTYWNY'
-- and birth_date is not null 
-- )
-- select 
-- *
-- from czySenior 
-- where czyJestSenior=false